# Firestore Setup Guide

This document describes the Firestore collections, indexes, and security rules for the Gamified Activity & Reward Tracker application.

## Collections Structure

### users
Stores user profile information.

**Fields:**
- `email` (string): User's email address
- `displayName` (string): User's display name from Google
- `photoURL` (string): User's profile photo URL
- `role` (string): Either "parent" or "child"
- `familyId` (string | null): ID of the family group the user belongs to
- `theme` (string): Selected theme preference
- `createdAt` (timestamp): Account creation timestamp

**Document ID:** Firebase Auth UID

### families
Stores family group information.

**Fields:**
- `inviteCode` (string): Unique 6-character alphanumeric code for joining
- `ownerId` (string): User ID of the family owner (parent)
- `members` (array of strings): Array of user IDs in the family
- `createdAt` (timestamp): Family creation timestamp

**Document ID:** Auto-generated by Firestore

### activities
Stores trackable activities defined by parents.

**Fields:**
- `familyId` (string): ID of the family this activity belongs to
- `name` (string): Activity name (e.g., "Reading")
- `unit` (string): Unit of measurement (e.g., "Pomodoro", "Day")
- `rate` (number): Monetary value per unit
- `createdBy` (string): User ID of the parent who created it
- `createdAt` (timestamp): Activity creation timestamp

**Document ID:** Auto-generated by Firestore

### logs
Stores activity log entries created by children.

**Fields:**
- `activityId` (string): Reference to the activity
- `userId` (string): ID of the child who logged the activity
- `familyId` (string): ID of the family (for efficient querying)
- `units` (number): Number of units completed
- `timestamp` (timestamp): When the activity was logged
- `verificationStatus` (string): "pending", "approved", or "rejected"
- `verifiedBy` (string | null): User ID of parent who verified
- `verifiedAt` (timestamp | null): When verification occurred

**Document ID:** Auto-generated by Firestore

## Indexes

The following composite indexes are required for efficient queries:

### logs collection
1. **Family pending verifications:**
   - `familyId` (Ascending)
   - `verificationStatus` (Ascending)
   - `timestamp` (Descending)
   
   Used for: Fetching pending logs for parent verification interface

2. **User activity history:**
   - `userId` (Ascending)
   - `timestamp` (Descending)
   
   Used for: Displaying a child's activity history

3. **Activity logs:**
   - `activityId` (Ascending)
   - `timestamp` (Descending)
   
   Used for: Fetching all logs for a specific activity

### activities collection
1. **Family activities:**
   - `familyId` (Ascending)
   - `createdAt` (Descending)
   
   Used for: Fetching all activities for a family

### families collection
1. **Invite code lookup:**
   - `inviteCode` (Ascending)
   
   Used for: Fast lookup when joining a family with an invite code

## Deploying Indexes

To deploy the indexes to your Firebase project:

```bash
firebase deploy --only firestore:indexes
```

## Security Rules

The security rules enforce:
- Authentication required for all operations
- Family-based data isolation (users can only access their family's data)
- Role-based access control (parents can create/delete, children can only log)
- Users can only modify their own profile

To deploy the security rules:

```bash
firebase deploy --only firestore:rules
```

## Testing with Firebase Emulator

To test locally with the Firebase Emulator:

1. Install Firebase CLI:
```bash
npm install -g firebase-tools
```

2. Initialize Firebase in your project:
```bash
firebase init
```

3. Start the emulator:
```bash
firebase emulators:start
```

4. Update your frontend and backend to use the emulator:

**Frontend (.env.local):**
```
NEXT_PUBLIC_FIREBASE_USE_EMULATOR=true
```

**Backend (.env):**
```
FIRESTORE_EMULATOR_HOST=localhost:8080
```

## Data Migration

If you need to migrate existing data or seed test data, create a script using the Firebase Admin SDK:

```python
from firebase_admin import firestore
import firebase_admin

# Initialize Firebase Admin
cred = firebase_admin.credentials.Certificate('path/to/serviceAccount.json')
firebase_admin.initialize_app(cred)

db = firestore.client()

# Example: Create a test family
family_ref = db.collection('families').document()
family_ref.set({
    'inviteCode': 'TEST01',
    'ownerId': 'parent_user_id',
    'members': ['parent_user_id', 'child_user_id'],
    'createdAt': firestore.SERVER_TIMESTAMP
})
```

## Monitoring and Maintenance

- Monitor index usage in Firebase Console > Firestore > Indexes
- Check for missing indexes in the Firebase Console
- Review security rules regularly for any needed updates
- Set up alerts for unusual access patterns
- Implement data retention policies for old logs
